# Backtester - Краткий гайд

## Быстрый старт

```bash
# 1. Настрой период и параметры
edit simulation.config.json

# 2. Создай кэш RM (один раз для каждого range)
node cache-rm-data.js 0.007    # ~30-60 секунд для недели

# 3. Прогони матрицу параметров
node run-matrix.js 0.007
```

## Файлы

| Файл | Описание |
|------|----------|
| `simulation.config.json` | Настройки: период, размер позиции, плечо |
| `cache-rm-data.js` | Кэширует RM probability (параллельно, ~300 req/sec) |
| `run-matrix.js` | Прогон всех комбинаций параметров |
| `analyze-best.js` | Детальный анализ каждой сделки |
| `rm-cache/` | Папка с кэшами RM |
| `results/` | Результаты матриц (JSON) |

## Конфиг (simulation.config.json)

```json
{
  "fromDate": "2025-09-05",    // Начало периода
  "toDate": "2025-09-11",      // Конец периода
  "positionSize": 0.5,         // Маржа в ETH
  "leverage": 3,               // Плечо (3x = позиция 1.5 ETH)
  "cycleTime": 10,             // Длина цикла в минутах
  "range": 0.007               // Диапазон цены (0.7%)
}
```

## Логика стратегии

1. **Каждую минуту**: проверяем RM probability
2. **Если probability >= minProbability**: начинаем цикл, фиксируем границы
3. **Внутри цикла**: ждём когда цена достигнет entry зоны
4. **Вход**: LONG если position <= entryLong, SHORT если position >= entryShort
5. **Выход**: SL (граница), TP (фиксированный %), или timeout (конец цикла)

## Расчёт PnL

```
Маржа:        0.5 ETH ($1200)
Плечо:        3x
Позиция:      1.5 ETH ($3600)

Движение +0.35%:
  Gross PnL = $3600 × 0.35% = $12.60
  Комиссии  = $3600 × 0.045% × 2 = $3.24
  Net PnL   = $12.60 - $3.24 = $9.36
```

**Slippage**: применяется только к SL (0.01% для позиций до $10K)

## Матрица параметров (run-matrix.js)

Тестируемые параметры:
- `entryLong`: [0.25, 0.30, 0.33, 0.40]
- `entryShort`: [0.60, 0.67, 0.70, 0.75]
- `minProbability`: [0.85, 0.90, 0.93, 0.95, 0.98]
- `lockBeforeEnd`: [60, 120, 180, 240] секунд
- `tpPercent`: [0.20, 0.25, 0.30, 0.35, 0.40, 0.50]

Итого: ~1000+ комбинаций за ~30 секунд

## Оптимизации

1. **RM кэширование**: probability для каждой минуты → один кэш, много прогонов
2. **Параллельные запросы**: 300 req/sec вместо 8 req/sec
3. **Индекс свечей**: O(1) поиск вместо O(n) сканирования

## Лучшие результаты (на 2025-09-05 - 2025-09-11, range 0.7%)

| Entry | MinProb | Lock | TP% | WR | PnL |
|-------|---------|------|-----|-----|-----|
| 0.25/0.75 | 98% | 240s | 0.25% | 75% | +$24.95 |

(Без плеча. С 3x плечом PnL будет ×3 = ~$75)

## Важные моменты

- **SL/TP проверяется по high/low свечей**, не по close
- **Границы фиксируются** на момент начала цикла
- **Funding rate** не учитывается (позиции < 10 минут)
- **Комиссии**: taker 0.045% на вход и выход

## Типичные проблемы

**Кэш не найден**: сначала создай кэш для нужного range
```bash
node cache-rm-data.js 0.007
```

**Мало сделок**: попробуй снизить minProbability или расширить entry зоны

**Все в минусе**: проверь range (0.5% слишком узкий при высокой волатильности)
